<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<title>DISP</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=8" />
<link href="jquery.simpledialog.css" type="text/css" rel="stylesheet" />
<style type="text/css">
body{
margin:0.5em;
background:#000;
color:#fff;
overflow-x:hidden;
}
a{
color:lightblue;
text-decoration:none;
}
a:visited{
color:Aqua;
}
#feedurl{
width: 120px;
}
th{
text-align:left;
}
#keyword{
width: 100px;
}
#container{
margin: 0 auto;
padding: 0;
width: 750px;
}
.center{
text-align: center;
}
.collapsed{
margin-left: 0em !important;
}
.entry-container{
display:none;
}
img{
border:0;
max-height: 480px;
max-width: 640px;
overflow: hidden;
}
.entry-date{
float:right;
}
.source{
float: right;
margin-right: 0.5em;
}
.link-out{
color:#666;
}
.feed-title{
margin: 0;
display: inline;
position: static;
width: auto;
font-size: 100%;
font-weight: bold;
margin-right: 0.5em;
display: inline;
}
#userdata{
float: left;
}
#maxFeed{
width: 25px;
}
.found{
color:red;
font-weight: strong;
}
table, th, td{
border:0;
}
.collapsed:hover{
background:#999;
}
</style>
</head>
<body>
    <div id="container">
        <div id="query">          
			<form name="f" method="post" action="">
			Keyword(Optional): <input id="keyword" name="keyword" type="text" value="" />            
			Board:
			<select name="board" id="board">
				<option>ACG</option>
				<option>AFIAC</option>
				<option>Afu</option>				    
				<option>AgeOfEmpire</option>
				<option>AKB48</option>
				<option>Android</option>
				<option>Anonymous</option>
				<option>anti</option>
				<option>Apply_Board</option>
				<option>Aries</option>
				<option>ASCII_Art</option>
				<option>Ask</option>
				<option>BabyMother</option>
				<option>Baseball</option>
				<option>Beauty</option>
				<option>BOSS</option>
				<option>Boy-Girl</option>
				<option>BuyTogether</option>
				<option>Car</option>
				<option>Chat</option>
				<option>Chiayi</option>
				<option>CommPriciple</option>
				<option>Contemp_Music_Arts</option>
				<option>CuteKids</option>
				<option>dark_share</option>
				<option>DC</option>
				<option>DIABLO</option>
				<option>DietDiary</option>
				<option>DispBBS</option>
				<option>DispBug</option>
				<option>DispNewHand</option>
				<option>DispSuggest</option>
				<option>DJJ_Course</option>
				<option>Doraemon</option>
				<option>Dragracing</option>
				<option>DYU</option>
				<option>e-shopping</option>
				<option>EA_Drama</option>
				<option>ele_mon_TD</option>
				<option>English</option>
				<option>EZsoft</option>
				<option>Facebook</option>
				<option>FCBarcelona</option>
				<option>FleaMarket</option>
				<option>Food</option>
				<option>FW</option>
				<option>GASHAPON</option>
				<option>Gay</option>
				<option>Gossiping</option>
				<option>Haruhi</option>
				<option>Hate</option>
				<option>HC_Guitar</option>
				<option>Hindi</option>
				<option>Hsinchu</option>
				<option>humorous</option>
				<option>Instrument</option>
				<option>JapanDrama</option>
				<option>Joke</option>
				<option>K-ON</option>
				<option>Kaohsiung</option>
				<option>Knuckles_note</option>
				<option>KoreaDrama</option>
				<option>layzer</option>
				<option>learner</option>
				<option>Little_Games</option>
				<option>LIVE</option>
				<option>Madoka</option>
				<option>MathThinking</option>
				<option>MBA</option>
				<option>MH</option>
				<option>Mobile-Computers</option>
				<option>Modchip</option>
				<option>Motorcycle</option>
				<option>Movie</option>
				<option>Nantou</option>
				<option>NBA</option>
				<option>NCCU</option>
				<option>NCKU</option>
				<option>NCNU</option>
				<option>NCTU</option>
				<option>NCU</option>
				<option>ncuacg2</option>
				<option>NDHU</option>
				<option>NEWS</option>
				<option>NewTaipeiCity</option>
				<option>NoMoney</option>
				<option>novel</option>
				<option>NSYSU</option>
				<option>NTHU</option>
				<option>NTU</option>
				<option>NTU_Lab_DISP</option>
				<option>NTUST</option>
				<option>ONE_PIECE</option>
				<option>PC_Shopping</option>
				<option>Perfume</option>
				<option>P_qman</option>
				<option>Programming</option>
				<option>PTT</option>
				<option>ReadingBooks</option>
				<option>River</option>
				<option>Saimoe</option>
				<option>Science</option>
				<option>seiyuu</option>
				<option>skate</option>
				<option>SNSD</option>
				<option>StarCraft</option>
				<option>Stock</option>
				<option>studyabroad</option>
				<option>Stupid</option>
				<option>TableTennis</option>
				<option>Taichung</option>
				<option>Tainan</option>
				<option>Taipei</option>
				<option>TaiwanRich</option>
				<option>Taoyuan</option>
				<option>Tech_Job</option>
				<option>Test</option>
				<option>Thai</option>
				<option>TPPO</option>
				<option>TyPhoon</option>
				<option>VideoShare</option>
				<option>WaKnow</option>
				<option>Wanted</option>
				<option>Warcraft</option>
				<option>Wish</option>
				<option>Yunlin</option>
				<option>YZU</option>
			</select>
			Feed: <input id="feedurl" type="text" value="http://disp.cc/rss/Test.xml" /> 			
			<input id="loaduserdata" type="submit" value="Get" />
            Max:<input id="maxFeed" type="text" value="100" />
			</form>
        </div>
		
		<div id="result">
			<table id="userdata" border="1" width="100%">
				<thead>
					<th>
						Results <a id="itemsToggle" href="">(Toggle All Items)</span>
					</th>					
				</thead>
				<tbody>
				</tbody>
			</table>			
		</div>
    </div>
	<p style="clear:both">&nbsp;</p>
<script type="text/javascript" src="https://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
<script type="text/javascript" src="jquery.simpledialog.js"></script>
<script type="text/javascript">
/*
 * tomin@June, 2011
 *
 * Todo: external RSS anchor
 * 
 */
 
var link_index;

$.YQL = function(query, callback) { 
    if (!query || !callback) {
        throw new Error('$.YQL(): Parameters may be undefined');
    }
 
    var encodedQuery = encodeURIComponent(query),
    url = 'http://query.yahooapis.com/v1/public/yql?q='
         + encodedQuery + '&format=json&callback=';
	//$("body").prepend(url);
	$.getJSON(url, callback);			
};

/*
 * jGFeed 1.0 - Google Feed API abstraction plugin for jQuery
 *
 * Licensed under the GPL license:
 *   http://www.gnu.org/licenses/gpl.html
 *
 */
$.jGFeed = function(url, fnk, num, key) { 
  if(url == null) return false;
  
  var gurl = "http://ajax.googleapis.com/ajax/services/feed/load?v=1.0&callback=?&q="+url;
  if(num != null) gurl += "&num="+num;
  if(key != null) gurl += "&key="+key;
  //$("body").prepend(gurl);
  
  $.getJSON(gurl, function(data){
	if(!data.responseData){
		alert("System Busy or unable to fetch data");//系統忙線中，請稍候再試！或是該看版暫不開放資料外連。
		return false;
	}
	
	if(typeof fnk == 'function' && data.responseData.feed!=null)
	  fnk.call(this, data.responseData.feed);
	else
	  return false;
  });

};

function parseJG(){
	var maxFeed = $('#maxFeed').val().match(/\d+/);
	if(!maxFeed) maxFeed = 100;	
	var keyword = $("#keyword").val();
	var keywordlength = keyword.replace(/^\s+|\s+$/g,"").length;		
	var feedurl = $('#feedurl').val();
	var tblRow = "";	
	
	$.jGFeed(feedurl +'?time='+new Date(),function(feeds){	  
		if(!feeds){		
			// there was an error
			return false;
		}  
		link_index = 0;
		for(var i=0,length=feeds.entries.length; i<length; i++){
			var entry = feeds.entries[i];
			var year = entry.publishedDate.substr(12,4);
			var month = entry.publishedDate.substr(8,3);
			var date = entry.publishedDate.substr(5,2);
			var _time = month + " " + date + ", " + year;
			var _href = entry.link;
			var _content = entry.content;
			var _title = entry.title;		

			tblRow += targetHTML(_href, _content, _title, _time);
		}
		
		$("#userdata tbody").html(tblRow);
		last();		
	}, maxFeed);
		
}
function markKeyword(){
	var keyword = $("#keyword").val();
	var keywordlength = keyword.replace(/^\s+|\s+$/g,"").length;		
	
	if (keywordlength != 0 ){	
		$(".link-title, .entry-container").each(function(){
			var target = $(this).html();
			if(target.match(keyword))
				$(this).html( target.replace(new RegExp(keyword,'g'),"<span class=found>" + keyword + "</span>"));
		});		
	}		
}
function parserURL(_content){
	if(!_content.match(/(href|src)=/g)){//non html
		_content = _content.replace(/(^")\bhttps?:[\w\.\/%\?\&\=;\-~@\,]+\b/g,"<a href='$&' target='_blank'>$&</a>");
		_content = _content.replace(/<a href=[^<]+<\/a>/g, "<div class=href>$&</div>");
		_content = _content.replace(/<a href=[^>]+\/\/(\w+\.youtube\.[^\/]+)\/watch\?[^>]*v=([^>"&\']+)[^>]+>[^<]+<\/a>/g, '<object width="640" height="400"><param name="movie" value="http://$1/v/$2&hl=en&fs=1"></param><param name="allowFullScreen" value="true"></param><embed src="http://$1/v/$2&hl=en&fs=1" type="application/x-shockwave-flash" allowfullscreen="true" width="640" height="390"></embed></object>');
		_content = _content.replace(/<a href=[^>]+\/\/(youtu\.be)\/([^>"&\']+)[^>]+>[^<]+<\/a>/g, '<iframe width="640" height="400" src="http://www.youtube.com/embed/$2" frameborder="0" allowfullscreen></iframe>');
		_content = _content.replace(/<a href=[^>]+\/\/(vimeo\.com)\/([^>"&\']+)[^>]+>[^<]+<\/a>/g, '<iframe src="http://player.vimeo.com/video/$2?title=0&amp;byline=0&amp;portrait=0" width="640" height="400" frameborder="0"></iframe>');
		_content = _content.replace(/<a href=[^>]+\/\/([^>"&\']+)\.(jpg|png|jpeg|gif){1}[^>]+>[^<]+<\/a>/g, 'http://$1.$2 <br/><img src="http://$1.$2" />');
		_content = _content.replace(/<a href=[^>]+\/\/(mymedia\.yam\.[^\/]+)\/\w{1}\/([^>"&\']+)[^>]+>[^<]+<\/a>/g, '$&<br/><object width="450" height="120"><param name="movie" value="http://mymedia.yam.com/*/$2"></param><param name="quality" value="high"></param><param name="wmode" value="transparent"></param><embed src="http://mymedia.yam.com/*/$2" quality="high" type="application/x-shockwave-flash" wmode="transparent" width="450" height="120"></embed></object>');
		_content = _content.replace(/<a href=[^>]+\/\/(\w+\.xiami\.[^\/]+)\/\w+\/([^>"&\']+)[^>]+>[^<]+<\/a>/g, '$&<br/><embed src="http://www.xiami.com/widget/0_$2/singlePlayer.swf" type="application/x-shockwave-flash" width="257" height="33" wmode="transparent"></embed>');		
	}
	return _content;
}
function targetHTML(_href, _content, _title, _time){	
	var keyword = $("#keyword").val();
	var keywordlength = keyword.replace(/^\s+|\s+$/g,"").length;
	var html = "";
	var key = _href.replace(/.+-(\w+)/,"$1");//unique time	
	var board = $("#board").val();
	var anchor = board + "," + key;
	
	if (keywordlength == 0 || (keywordlength != 0 && ( _title.match(new RegExp(keyword))!=null  || _content.match(new RegExp(keyword))!=null )) ){	
		_content = parserURL(_content);
		link_index++;
		html = 	"<tr><td><a id='a" + key + "' name='" + anchor + "'></a><div class='entry'>" +
				"<div class='collapsed' id='index_" + link_index + "'>" +
					"<div class='feed-title'>" + link_index + ' : ' +
						"<a class='link-title' rel='r" + link_index + "' href='#" + anchor + "'>" + _title + "</a>"  +	
					 "</div>" + 
					 "<div class='source'>&nbsp;&nbsp;<a class='link-out' target='_blank' href='" + _href + "'>[link]</a></div>"  +
					 "<div class='entry-date'>" + _time + "</div>" +					 
				 "</div>" +
				 "<div class='entry-container' id='r" + link_index + "'>" + _content + "</div></div></div>" +
				 "</div></td></tr>";
	}	
	return html;
}
function clearKeyword(){
	var tbody = $("#userdata tbody");
	var tbodyhtml = tbody.html().replace(/\<\/?span( class=\"?(found)?\"?)?\>/g,"");
	tbody.html(tbodyhtml);
}
function keywordFilter(){
	var keyword = $("#keyword").val();
	var keywordlength = keyword.replace(/^\s+|\s+$/g,"").length;
	
	if (keywordlength !=0 ){
		$(".trfound, .found").removeClass();
		$("tr").show();	
		clearKeyword();
			
		$(".link-title, .entry-container").each(function(){
			if($(this).text().match(keyword))
				$(this).parents("tr").addClass("trfound");
		});		
		
		$("tr").hide();
		$(".trfound").show();
		markKeyword();
	}else{
		clearKeyword();
		$('tr').show();
		//$('form').submit();
	}
}

function parseYQL(){
	if ($.browser.msie || $.browser.webkit || $.browser.opera){ 
		parseJG();
		return;
	}

	var maxFeed = $('#maxFeed').val().match(/\d+/);
	if(!maxFeed) maxFeed = 100;	
	var feedurl = $('#feedurl').val();
	var baseGoogleFeedURL = "http://www.google.com/reader/api/0/stream/contents/feed/";		
	var YQLURL = "select * from json where url='" + baseGoogleFeedURL + feedurl + "?n=" + maxFeed + "'";		
	var tblRow = "";
	var keyword = $("#keyword").val();
	//if(keyword.length>0) YQLURL = YQLURL + " and YQLURL";
	
						
	$.YQL(YQLURL, function(data) {
	
		if(data.query.results==null){//no cache on google reader
			parseJG();
			return;
		}

		link_index = 0;
		$.each(data.query.results.json.items, function (i, n) {
			var _time = new Date();
			_time.setTime(n.crawlTimeMsec);
			_time = _time.toLocaleDateString();
			var _href;
			var _content;
			var _title;
			if (typeof n.alternate != 'undefined') { _href = n.alternate.href; } else { _href = ""; }						
			if (typeof n.title != 'undefined') { _title = n.title; } else { _title = ""; }
			if (typeof n.content != 'undefined') { _content = n.content.content; }
			else if (typeof n.summary != 'undefined') { _content = n.summary.content; } 
			else { _content = ""; }

			tblRow += targetHTML(_href, _content, _title, _time);			
		});
						
		$("#userdata tbody").html(tblRow);
		last();
	});
}

function init(){
	//file: .+\.html     index: .+foldername\/	
	var url = location.href;
	var parameters = url.replace(/.+ps\//g,"").replace(/#/g,"").split(",");
	if(url.match(/.+\.html/g)){
		parameters = url.replace(/.+\.html/g,"").replace(/#/g,"").split(",");
	}
	var board = parameters[0];

	if(board.length>0){
		$("#board").val(board);		
	}else{
		$("#board").val("Test");
	}
	var RSS = "http://rss.disp.cc/";
	$("#feedurl").val( RSS + $('#board').val() + ".xml");
	$("form").submit();
}

function last(){
	if(link_index==0){
		alert("No data");//查無資料
		return;
	}
	var url = location.href;
	var parameters = url.replace(/.+ps\//g,"").replace(/#/g,"").split(",");
	if(url.match(/.+\.html/g)){	
		parameters = url.replace(/.+\.html/g,"").replace(/#/g,"").split(",");
	}	
	
	var key = parameters[1];

	if(key!=null && key.length>0){
		location.href = location.href;
	}
	markKeyword();		
	//$("#a"+key).parent().find(".entry-container").show();
	$('.link-title').simpleDialog({
		height: "700px"
	});	
}
$(function () {
	$('form').submit(function () {				
		$("#userdata tbody").html("<tr><td class=center>Now loading...</td></tr>");		
		parseYQL();
		return false;
	});
	$('#board').change(function () {				
		var RSS = "http://rss.disp.cc/";
		$("#feedurl").val( RSS + $('#board').val() + ".xml");
		location.href = location.href.replace(/#.+/g,"") + "#" + $("#board").val();
		$('form').submit();
	});
	$('.link-title').live("click",function () {
		//$(this).parents(".collapsed").next().toggle();
	});
	$("#keyword").focus();
	$("#keyword").keyup(function(){
		setTimeout(keywordFilter,100);
	});		
	$("#itemsToggle").click(function () {				
		$(".entry-container").toggle();
		return false;
	});
	init();	
});

</script>
</body>
</html>